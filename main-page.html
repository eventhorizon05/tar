<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tap And Repair</title>
    <link rel="stylesheet" href="bootstrap.css">
    <script src="bootstrap.js"></script>
    <script src="jquery.js"></script>
</head>
<script>
    $(document).ready(function(){
        //hidden parts
        $('#approvedUserSection,#mechanicsSection,#requestMechanicsSection').hide();
        
        var loadingScreen = $('.loadingScreen');
        
        $.ajax({
            type: 'GET',
            url: 'php/sessioncheck.php',
            success:function(response){
                if( response == 'index.html'){
                    loadingScreen.slideDown('fast', function(){
                        window.location.replace(response);
                    });
                }
            }
        });
        
        var logoutButton = $('#logOut');
        var userSection = $('#userSection');
        var mechanicsSection = $('#mechanicsSection');
        var approvedUserSection = $('#approvedUserSection');
        var requestMechanicsSection = $('#requestMechanicsSection');
        var requestMechanicsTable = $('#requestMechanicsTable');
        var userTable = $('#userTable');
        var approvedUsersTable = $('#approvedUserTable');
        var approvedMechanicsTable = $('#approvedMechanicsTable');
        var navApprovedAccounts = $('#navApprovedAccounts');
        var navAccountRequests = $('#navAccountRequests');
        var navRequestMechanics = $('#navRequestMechanics');
        var navMechanics = $('#navMechanics');
        var globalProductId = 0;
        var userFirstNameEdit = $('#userFirstNameEdit');
        var userLastNameEdit = $('#userLastNameEdit');
        var userEmailEdit = $('#userEmailEdit');
        var userContactNumberEdit = $('#userContactNumberEdit');
        var userNameUpdateBtn = $('#userNameUpdateBtn');
        var userEmailUpdateBtn = $('#userEmailUpdateBtn');
        var userContactNumberUpdateBtn = $('#userContactNumberUpdateBtn');
        var updateApprovedUserModal = $('#updateApprovedUserModal');
        
        userFirstNameEdit.on('keydown', function(){
            $(this).removeClass('is-invalid');
        });
        userLastNameEdit.on('keydown', function(){
            $(this).removeClass('is-invalid');
        });
        userEmailEdit.on('keydown', function(){
            $(this).removeClass('is-invalid');
        });
        userContactNumberEdit.on('keydown', function(){
            $(this).removeClass('is-invalid');
        });
        
        userNameUpdateBtn.click(function(){
            if(userFirstNameEdit.val() == ""){
                userFirstNameEdit.addClass('is-invalid');
            }
            if(userLastNameEdit.val() == ""){
                userLastNameEdit.addClass('is-invalid');
            }
            if(userFirstNameEdit.val() && userLastNameEdit.val() != ""){
                if(confirm('Update Name?') == true){
                    updateApprovedUserModal.modal('hide');
                    loadingScreen.show();
                    $.ajax({
                        type: 'POST',
                        url: 'php/updateUserName.php',
                        data:
                        {
                            requestId: globalProductId,
                            first_name: userFirstNameEdit.val(),
                            last_name: userLastNameEdit.val(),
                        },
                        success:function(response){
                            userFirstNameEdit.val("");
                            userLastNameEdit.val("");
                            approvedUsersTable.children().remove();
                            getApprovedUsers();
                            loadingScreen.slideUp('fast');
                        }
                    });
                }
            }
        });
        userEmailUpdateBtn.click(function(){
            if(userEmailEdit.val() == ""){
                userEmailEdit.addClass('is-invalid');
            }
            if(userEmailEdit.val() != ""){
                if(confirm('Update Email?') == true){
                    updateApprovedUserModal.modal('hide');
                    loadingScreen.show();
                    $.ajax({
                        type: 'POST',
                        url: 'php/updateUserEmail.php',
                        data:
                        {
                            requestId: globalProductId,
                            email: userEmailEdit.val(),
                        },
                        success:function(response){
                            if(response == 'success'){
                                userEmailEdit.val("");
                                approvedUsersTable.children().remove();
                                getApprovedUsers();
                                loadingScreen.slideUp('fast');
                            }
                        }
                    });
                }
            }
        });
        userContactNumberUpdateBtn.click(function(){
            if(userContactNumberEdit.val() == "" || userContactNumberEdit.val().charAt(0) != '0' || userContactNumberEdit.val().charAt(1) != '9' || userContactNumberEdit.val().length != 11){
                userContactNumberEdit.addClass('is-invalid');
            }
            if(userContactNumberEdit.val().charAt(0) == '0' && userContactNumberEdit.val().charAt(1) == '9' && userContactNumberEdit.val().length == 11){
                if(confirm('update Contact Number?') == true){
                    updateApprovedUserModal.modal('hide');
                    loadingScreen.show();
                    $.ajax({
                        type: 'POST',
                        url: 'php/updateUserContactNumber.php',
                        data:
                        {
                            requestId: globalProductId,
                            contact_number: userContactNumberEdit.val(),
                        },
                        success:function(response){
                            if(response == 'success'){
                                userContactNumberEdit.val("");
                                approvedUsersTable.children().remove();
                                getApprovedUsers();
                                loadingScreen.slideUp('fast');
                            }
                        }
                    });
                }
            }
        });
        
        function getApprovedUsers(){
            $.ajax({
                type: 'POST',
                url: 'php/getApprovedUsers.php',
                success:function(response){
                    var data = JSON.parse(response);
                    $(data).each(function(index,value){
                        approvedUsersTable.append(`
                            <tr>
                                <td>${value.last_name}, ${value.first_name}</td>
                                <td>${value.email}</td>
                                <td>${value.contact_number}</td>
                                <td>${value.updated_at}</td>
                                <td>
                                    <button class="editApprovedUserBtn btn btn-outline-warning" value="${value.id}" data-bs-toggle="modal" data-bs-target="#updateApprovedUserModal">Update</button>
                                    <button class="terminateApprovedUserBtn btn btn-outline-danger" value="${value.id}">Terminate</button>
                                </td>
                            </tr>
                        `);
                    });
                    var ediApprovedUserBtn = $('.editApprovedUserBtn');
                    var terminateApprovedUserBtn = $('.terminateApprovedUserBtn');
                    
                    ediApprovedUserBtn.click(function(){
                        globalProductId = $(this).val();
                    });
                    
                    terminateApprovedUserBtn.click(function(){
                        if(confirm('Terminate This Account?') == true){
                            var thisBtn = $(this);
                            loadingScreen.show();
                            globalProductId = $(this).val();
                            $.ajax({
                                type: 'POST',
                                url: 'php/terminateApprovedUser.php',
                                data:
                                {
                                    requestId: globalProductId,
                                },
                                success:function(response){
                                    if(response == 'success'){
                                        loadingScreen.slideUp('fast', function(){
                                            alert('Account Terminated.');
                                            thisBtn.parent().parent().remove();
                                        });
                                    }else{
                                        loadingScreen.slideUp('fast', function(){
                                            alert('Server Error!');
                                        });
                                    }
                                }
                            });
                            
                        }
                    });
                }
            });
        }
        
        function getUserRequests(){
                $.ajax({
                type: 'POST',
                url: 'php/getUsers.php',
                success: function(response){
                    var data = JSON.parse(response);
                    $(data).each(function(index,value){
                        userTable.append(`
                            <tr>
                                <td>${value.last_name}, ${value.first_name}</td>
                                <td>${value.email}</td>
                                <td>${value.contact_number}</td>
                                <td>${value.created_at}</td>
                                <td>
                                    <button class="approveRequestBtn btn btn-outline-dark" value="${value.id}">Approve</button>
                                    <button class="declineRequestBtn btn btn-outline-warning" value="${value.id}">Decline</button>
                                </td>
                            </tr>
                        `);
                    });
                    var approveRequestBtn = $('.approveRequestBtn');
                    var declineRequestBtn = $('.declineRequestBtn');

                    approveRequestBtn.click(function(){
                        if(confirm('Approve this Request?') == true){
                            var thisButton = $(this);
                            globalProductId = $(this).val();
                            loadingScreen.show();
                            $.ajax({
                                type: 'POST',
                                url: 'php/approveRequest.php',
                                data:
                                {
                                    requestId: globalProductId,
                                },
                                success:function(response){
                                    if(response == 'success'){
                                        loadingScreen.slideUp('fast', function(){
                                            alert('Request Approved.');
                                            thisButton.parent().parent().remove();
                                        });
                                    }
                                }

                            });
                        }
                    });
                    declineRequestBtn.click(function(){
                        globalProductId = $(this).val();
                        var thisButton = $(this);
                        if(confirm('Decline Request?') == true){
                            loadingScreen.show();
                            $.ajax({
                                type: 'POST',
                                url: 'php/declineRequest.php',
                                data:
                                {
                                    requestId: globalProductId,
                                },
                                success:function(response){
                                    if(response == 'success'){
                                        loadingScreen.slideUp('fast', function(){
                                            alert('Request Deleted.');
                                            thisButton.parent().parent().remove();
                                        });

                                    }else{
                                        loadingScreen.hide('fast', function(){
                                            alert('Server Error!');
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
        };
        function getMechanics(){
            $.ajax({
                type: 'POST',
                url: 'php/getMechanics.php',
                success:function(response){
                    var data = JSON.parse(response);
                    $(data).each(function(index,value){
                        approvedMechanicsTable.append(`
                            <tr>
                                <td>${value.last_name}, ${value.first_name}</td>
                                <td>${value.email}</td>
                                <td>${value.contact_number}</td>
                                <td>${value.created_at}</td>
                                <td>
                                    <button class="editApprovedMechanicBtn btn btn-outline-warning" value="${value.id}" data-bs-toggle="modal" data-bs-target="#updateApprovedMechanicModal">Update</button>
                                    <button class="terminateApprovedMechanicBtn btn btn-outline-danger" value="${value.id}">Terminate</button>
                                </td>
                            </tr>
                        `);
                    });
                    var editApprovedMechanicBtn = $('.editApprovedMechanicBtn');
                    var terminateApprovedMechanicBtn = $('.terminateApprovedMechanicBtn');
                    
                    terminateApprovedMechanicBtn.click(function(){
                        if(confirm('Terminate Mechanic?') == true){
                            globalProductId = $(this).val();
                            var thisButton =$(this);
                            loadingScreen.show();
                            $.ajax({
                                type: 'POST',
                                url: 'php/terminateApprovedMechanic.php',
                                data:
                                {
                                    requestId: globalProductId,
                                },
                                success:function(response){
                                    if(response == 'success'){
                                        loadingScreen.slideUp('fast', function(){
                                            thisButton.parent().parent().remove();
                                            alert('Mechanic Terminated.');
                                        })
                                    }else{
                                        loadingScreen.slideUp('fast', function(){
                                            alert('Server Error!');
                                        })
                                    }
                                }
                            });
                        }
                    }); 
                }
            });
        }
        function getMechanicsRequest(){
            $.ajax({
                type: 'POST',
                url: 'php/getRequestMechanics.php',
                success:function(response){
                    console.log(response);
                    var data = JSON.parse(response);
                    $(data).each(function(index,value){
                        requestMechanicsTable.append(`
                            <tr>
                                <td>${value.last_name}, ${value.first_name}</td>
                                <td>${value.email}</td>
                                <td>${value.contact_number}</td>
                                <td>${value.created_at}</td>
                                <td>
                                    <button class="approveMechanicRequestBtn btn btn-outline-dark" value="${value.id}">Approve</button>
                                    <button class="declineMechanicRequestBtn btn btn-outline-warning" value="${value.id}">Decline</button>
                                </td>
                            </tr>
                        `);
                    });
                    var approveMechanicRequestBtn = $('.approveMechanicRequestBtn');
                    var declineMechanicRequestBtn = $('.declineMechanicRequestBtn');
                    
                    approveMechanicRequestBtn.click(function(){
                        if(confirm('Approve This Request?') == true){
                            globalProductId = $(this).val();
                            var thisButton = $(this);
                            loadingScreen.show();
                            $.ajax({
                                type: 'POST',
                                url: 'php/approveMechanicRequest.php',
                                data:
                                {
                                    requestId: globalProductId,
                                },
                                success:function(response){
                                    if(response == 'success'){
                                        loadingScreen.slideUp('fast', function(){
                                            thisButton.parent().parent().remove();
                                            alert('Request Approved?');
                                        });
                                    }else{
                                        loadingScreen.hide('fast', function(){
                                            alert('Server Error!');
                                        });
                                    }
                                }
                            });
                        }
                    });
                    declineMechanicRequestBtn.click(function(){
                        if(confirm('Decline Request?') == true){
                            globalProductId = $(this).val();
                            var thisButton = $(this);
                            loadingScreen.show();
                            $.ajax({
                                type: 'POST',
                                url: 'php/declineMechanicRequest.php',
                                data:
                                {
                                    requestId: globalProductId,
                                },
                                success:function(response){
                                    if(response == 'success'){
                                        loadingScreen.slideUp('fast', function(){
                                            thisButton.parent().parent().remove();
                                            alert('Request Deleted.');
                                        });
                                    }else{
                                        loadingScreen.hide('fast', function(){
                                            alert('Server Error!');
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }
        getUserRequests();
        
        navRequestMechanics.click(function(){
            requestMechanicsTable.children().remove();
            approvedUserSection.slideUp('fast');
            userSection.slideUp('fast');
            mechanicsSection.slideUp('fast');
            requestMechanicsSection.slideDown('slow');
            getMechanicsRequest();
        });
        navMechanics.click(function(){
            approvedMechanicsTable.children().remove();
            approvedUserSection.slideUp('fast');
            userSection.slideUp('fast');
            mechanicsSection.slideDown('slow');
            requestMechanicsSection.slideUp('fast');
            getMechanics();
        })
        navAccountRequests.click(function(){
            userTable.children().remove();
            approvedUserSection.slideUp('fast');
            mechanicsSection.slideUp('fast');
            userSection.slideDown('slow');
            requestMechanicsSection.slideUp('fast');
            getUserRequests();
        });
        navApprovedAccounts.click(function(){
            approvedUsersTable.children().remove();
            userSection.slideUp('fast');
            mechanicsSection.slideUp('fast');
            approvedUserSection.slideDown('slow');
            requestMechanicsSection.slideUp('fast');
            getApprovedUsers();
        });
        
        logoutButton.click(function(){
            if(confirm('Are You Sure?') == true){
                loadingScreen.show();
                $.ajax({
                    type: 'POST',
                    url: 'php/logout.php',
                    success:function(response){
                        if( response == "index.html"){
                            loadingScreen.slideDown('fast', function(){
                                window.location.replace(response);
                            });
                        }
                    }
                })
            }
        });
        
        
        
        
        
        loadingScreen.hide();
    });
</script>
<style>
    #loader{
        animation: loader 1.3s;
        animation-iteration-count: infinite;
        animation-timing-function: linear;
    }
    @keyframes loader{
        to{
            transform: rotate(360deg);
        }
    }
    .tthh{
        background: rgb(0,0,0);
        background: linear-gradient(144deg, rgba(0,0,0,1) 3%, rgba(255,201,0,1) 3%, rgba(255,201,0,1) 9%, rgba(0,0,0,1) 9%, rgba(0,0,0,1) 17%, rgba(255,201,0,1) 17%, rgba(255,201,0,1) 25%, rgba(0,0,0,1) 25%, rgba(0,0,0,1) 35%, rgba(255,201,0,1) 35%, rgba(255,201,0,1) 43%, rgba(0,0,0,1) 43%, rgba(0,0,0,1) 53%, rgba(255,201,0,1) 53%, rgba(255,201,0,1) 61%, rgba(0,0,0,1) 61%, rgba(0,0,0,1) 71%, rgba(255,201,0,1) 71%, rgba(255,201,0,1) 79%, rgba(0,0,0,1) 79%, rgba(0,0,0,1) 88%, rgba(255,201,0,1) 88%, rgba(255,201,0,1) 96%, rgba(0,0,0,1) 96%);
        color: white;
    }
    body{
        min-height: 100vh;background: rgb(14,32,52);background: linear-gradient(34deg, rgba(14,32,52,1) 10%, rgba(44,56,71,1) 14%, rgba(53,63,77,1) 20%, rgba(12,38,87,1) 29%, rgba(2,32,89,1) 46%, rgba(99,129,255,1) 53%, rgba(73,99,192,1) 64%, rgba(16,33,52,1) 73%, rgba(58,68,81,1) 100%);
    }
    main{
        margin-bottom: 50px;
    }
</style>
<body>
   <!-- loading screen -->
    <div class="loadingScreen" style="position: absolute;z-index: 99;width: 100%;height: 100vh;background-color: rgba(0,0,0,0.5);display: flex;align-items: center;justify-content: center;">
       <img id="loader" src="logo.png" alt="TAR logo" class="img-fluid" style="width: auto; max-height: 50px">
   </div>
   <header class="sticky-top bg-primary shadow-lg" style="z-index: 90;border-bottom: solid 2.5px rgba(0,0,0,0.8);">
       <nav class="navbar navbar-expand-lg navbar-dark py-0">
            <div class="container my-0">
                <div class="navbar-brand m-0">
                    <h1 style="font-family: fantasy;color: black;">
                        <img src="logo.png" height="70px" width="70px" alt="">Tap And Repair
                    </h1>
                </div>
                <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div id="nav-menu" class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto">
                      <li class="nav-item dropdown mt-2">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Mechanics</a>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#" id="navMechanics">Approved Mechanics</a></li>
                              <li><hr class="dropdown-divider"></li>
                              <li><a class="dropdown-item" href="#" id="navRequestMechanics">Request Mechanics</a></li>
                            </ul>
                       </li>
                       <li class="nav-item dropdown mt-2">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Accounts</a>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#" id="navApprovedAccounts">Approved Accounts</a></li>
                              <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="navAccountRequests">Requests</a></li>
                            </ul>
                       </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link mx-5">
                                <button class="btn" id="logOut">
                                    <img src="door-open.svg" alt="logout">Log Out
                                </button>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
   </header>
   <main>
       <section id="userSection">
            <div class="container">
                <div class="card mt-5 rounded-5 shadow">
                    <div class="card-header">
                        <h4 class="fw-bold my-3 mx-5">
                            Account Requests:
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <th scope="col">Name</th>
                                    <th scope="col">E-mail Address</th>
                                    <th scope="col">Contact Number</th>
                                    <th scope="col">Date Requested</th>
                                    <th scope="col">Operations</th>
                                </thead>
                                <tbody id="userTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
       </section>
       <section id="approvedUserSection">
            <div class="container">
                <div class="card mt-5 rounded-5 shadow">
                    <div class="card-header">
                        <h4 class="fw-bold my-3 mx-5">Approved Accounts:</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <th scope="col">Name</th>
                                    <th scope="col">E-mail Address</th>
                                    <th scope="col">Contact Number</th>
                                    <th scope="col">Date Approved</th>
                                    <th scope="col">Operations</th>
                                </thead>
                                <tbody id="approvedUserTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
       </section>
       <section id="mechanicsSection">
            <div class="container">
                <div class="card mt-5 rounded-5 shadow">
                    <div class="card-header">
                        <h4 class="fw-bold my-3 mx-5">Approved Mechanics:</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <th scope="col">Name</th>
                                    <th scope="col">E-mail Address</th>
                                    <th scope="col">Contact Number</th>
                                    <th scope="col">Date Approved</th>
                                    <th scope="col">Operations</th>
                                </thead>
                                <tbody id="approvedMechanicsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
       </section>
       <section id="requestMechanicsSection">
            <div class="container">
                <div class="card mt-5 rounded-5 shadow">
                    <div class="card-header">
                        <h4 class="fw-bold my-3 mx-5">Request Mechanics:</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <th scope="col">Name</th>
                                    <th scope="col">E-mail Address</th>
                                    <th scope="col">Contact Number</th>
                                    <th scope="col">Date Approved</th>
                                    <th scope="col">Operations</th>
                                </thead>
                                <tbody id="requestMechanicsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
       </section>
   </main>
   <footer></footer>
   <div class="modal fade" id="updateApprovedUserModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <div class="modal-title justify-content-between">
                        <h4>Update Account Information</h4>
                    </div>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <div style="display: flex;">
                            <div>
                                <input style="width: 100%;margin-right: 100%;" type="text" class="form-control mt-3" id="userFirstNameEdit" placeholder="First Name">
                                <div class="invalid-feedback">Please Fill up this field</div>
                            </div>
                            <div>
                                <span style="margin: 10px"></span>
                            </div>
                            <div>
                                <input style="width: 100%;margin-right: 100%;" type="text" class="form-control mt-3" id="userLastNameEdit" placeholder="Last Name">
                                <div class="invalid-feedback">Please Fill up this field</div>
                            </div>
                        </div>
                        <button id="userNameUpdateBtn" class="btn btn-md btn-success mt-2">Update Name</button>
                    </div>
                    <hr>
                    <div>
                        <input type="Email" class="form-control mt-3" id="userEmailEdit" placeholder="Email Address">
                        <div class="invalid-feedback">Please Fill up this field</div>
                        <button id="userEmailUpdateBtn" class="btn btn-md btn-success mt-2">Update Email</button>
                    </div>
                    <hr>
                    <div>
                        <input type="number" class="form-control mt-3" id="userContactNumberEdit" placeholder="Contact Number">
                        <div class="invalid-feedback">Invalid Contact Number</div>
                        <button id="userContactNumberUpdateBtn" class="btn btn-md btn-success mt-2">Update Contact Number</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>